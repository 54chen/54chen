title: [五四陈科学院]校内相册发展过程及核心技术分析爆料
link: http://www.54chen.com/architecture/54-chen-academy-schools-the-development-process-and-the-album-broke-the-heart-of-technical-analysis.html
author: cc0cc
description: 
post_id: 801
created: 2009/10/13 16:56:06
created_gmt: 2009/10/13 08:56:06
comment_status: open
post_name: 54-chen-academy-schools-the-development-process-and-the-album-broke-the-heart-of-technical-analysis
status: publish
post_type: post

# [五四陈科学院]校内相册发展过程及核心技术分析爆料

信春哥，转载的都给我注明出处：<http://www.54chen.com/801-54-chen-academy-schools-the-development-process-and-the-album-broke-the-heart-of-technical-analysis/> **前言** 感谢人人网曾经的吕威大侠、现在的文斌大侠、谢龙大侠对[人人网](/759-thousand-oaks-school-network-all-network-urgent-flash-as3-engineers-social-game-game-planning/)相册的不朽贡献，是吕威大侠精益求精的专研才有如此优秀的上传方案。 **第一章 相册瓶颈所在** 1.用户上传海量数据是一个头疼的事情，每天上千万的数量，又因为互联网的特殊性，会出现高峰期和低潮期，以每天10，000，000张图片来计算，高的时候，每秒上传有可能会在上千张，而低的时候可忽略不计。 2.因为产品不同，往往上传一张原始的照片会需要压缩成四五张不同大小的图片。这个压缩过程相当消费cpu。 相信有同一问题的应该有：QQ空间，网易相册，新浪博客，flikr等等。 **第二章 校内相册的发展和改革** 第一阶段，原始社会。 在第一阶段，我们过着刀耕火种的生活，java代码上传+jmagick压缩，其结果就是，再多的服务器，也搞不定越来越多的访问量。 第二阶段，具有封建主义气息的[资本](http://www.54chen.com/11-%e5%a4%a7%e5%ad%a6%e7%94%9f%e5%88%9b%e4%b8%9a%e6%a1%88%e4%be%8b%e5%88%86%e6%9e%90%e8%ae%b2%e7%a8%bf%e6%95%b4%e7%90%86/)主义社会。 这一阶段，我们痛定思痛啦，服务常常挂啊，怎么办？怎么办，当然是分布式处理，分析下原因，原来挂是因为cpu太高，用户上传一图压成四图，太费劲了。干脆传到其他cpu多的机器去。 说时迟那时快，我们挽起袖子，一个分布式的上传压缩过程就出来了。。。 所使用的方法： ![](http://www.54chen.com/wp-content/uploads/2009/10/qqe688aae59bbee69caae591bde5908d.jpg) 结果发现。。。没啥改观。。。 第三阶段，完全没有社会主义气息的共产主义社会。 改革春风吹满地，齐心协力跨世纪。 在吕威大侠的精心研究下，使用了以下的方案，将性能提高了**3.5**倍，同样数目的照片以前上传如需要100秒的，现在35秒即可以搞定。 **第三章 校内相册核心技术** 先上无码图： ![](http://www.54chen.com/wp-content/uploads/2009/10/qqe688aae59bbee69caae591bde5908d1.jpg) 看明白没，没看明白？好 继续看内容吧： 1)nginx:最前端服务器,负责接受来自client的上传文件请求及其他的相前web页面[请求](http://www.54chen.com/714-design-for-all-key-value-of-the-distributed-system-architecture-original/),把文件上传请求转发给lighttpd,把web页面请求转发给resin 2)lighttpd:负责接受所有文件上传,并把请求交给fastcgi处理(此处的fastcgi可以是本机可以是网络,目前用的是本机)，其实lighttpd完全可以取代nginx,把文件上传请求交给fastcgi,把其他请求交给resin处理,不过为了平稳过渡和平常重启,仍然用了nginx, 3)fastcgi:接受来自webserver的文件上传请求,处理并返回结果给webserver,多进程,可以由lighttpd启动,也可以由spawn-fcgi来启动,不过后者在fastcgi进程死掉的情况下不能自动重启,所以目前采用前者。fastcgi的上传代码很常规，压缩的代码使用了interl的icc和ipp的操作，对性能提升非常明显。 **第四章 目前还没有第四章 等待开源吧**

## Comments

**[unixhater](#11917 "2009-10-13 18:33:50"):** 最关键的海量存储系统没说

**[bera](#11918 "2009-10-13 21:14:46"):** 简单的说就是把所有请求都给resin变成了上传图片的给fastcgi 其他的给resin 然后采用了比较好的压缩算法？

**[blankyao](#11919 "2009-10-13 22:29:32"):** 为啥第二阶段会没有改观呢?

**[cc0cc](#11920 "2009-10-13 23:00:50"):** 海量存储系统不是这里说的瓶颈哦，人人网用的是国内一个商业分布式文件系统。

**[cc0cc](#11921 "2009-10-13 23:05:19"):** 这个理解是正确的

**[cc0cc](#11922 "2009-10-13 23:07:00"):** 第二阶段的网络开销太大了，文件上传这种事情，尽管在内网千兆环境，分布式搞起来也不能满足立刻出图的要求

**[yuehei](#11924 "2009-10-14 09:12:19"):** 感觉很普通，没有什么特别的地方

**[yuehei](#11925 "2009-10-14 09:14:46"):** 主要是海量存储，校内应该实力开发自己的海量存储系统

**[cc0cc](#11926 "2009-10-14 09:58:51"):** 呵呵 兄弟你遇到过同样的问题吗 能很普通地分享出来不

**[cc0cc](#11927 "2009-10-14 10:00:19"):** 商用有商用的好处，同时也有项目在用hadoop什么的处理一些事情，这里讨论的重点不是存储，而是压缩

**[haitian](#11928 "2009-10-14 10:09:46"):** 校内的图片上传还可以，但图片服务器的处理感觉在各大网站中最垃圾的。 经常遇到图片无法显示的情况，碰到多的时候直接无法正常浏览。我即使把图片地址直接放到我在IDC机房的服务器上访问，也一样。十分闹心。在其他网站上几乎遇不到这种情况。

**[cc0cc](#11929 "2009-10-14 10:35:08"):** 兄弟所言甚是，可惜这一块不在我们团队的可控范围内，只能等待未来领导们怎么处理了。

**[isll](#11930 "2009-10-14 11:01:49"):** 虽然重点不是存储，但能否说一下图片存储， 是基于你前面博客所写的dynamo类似的那个东东？

**[cc0cc](#11931 "2009-10-14 11:08:56"):** dynamo类似的那个东西是分布式的数据存储，我们正在实现中 这里是分布式的文件存储，有不少的商业公司专门做这个，用hadoop要实现也不难。

**[ideawu](#11932 "2009-10-14 12:26:16"):** 不明白第三种使用的技术为什么会缩短图片上传时间? 原来的100秒, 时间都花在哪了? 如果100秒和35秒都是在同一台服务器上获取的, 我看唯一的区别可能是进程增多了, 和请求被拆分了以应用流水线技术.

**[cc0cc](#11933 "2009-10-14 13:55:11"):** 兄弟看问题很透彻，原来的100s，在jmagick的消费上太在大，没有完全发挥intel的cpu优势，35s的时候，是因为：1.使用了一个简单的方案，将图片利用size来等比缩小后再进行缩图；2.使用了ipp和icc

**[ideawu](#11937 "2009-10-14 14:42:00"):** 这样看来, 似乎性能的提升和架构的变更没有太大关系, 但开始我以为文章的重点在于架构的变更. 还是我的理解有误, 其实第一种和第三种的架构就是同一种? 能不能把100秒时的架构图也传上来看看? 另外, 使用第一种架构, 然后改用第三种架构的图像处理算法和技术, 测试的结果会是多少呢? 我对这个很感兴趣. 如果设计合理, 使用多台服务器进行处理, 性能应该会比单台更好的. 但文中提到前两种都没有改进, 所以, 看完本文, 疑惑很多.

**[cc0cc](#11938 "2009-10-14 14:51:05"):** 因为有些东西不好太露骨，望体谅，不过讨论出来的话你应该能理解，也不会有人来盯着我在讨论什么 第一种是传统的jmagick 其实也就是java-jni-c这样的过程，第三种是c++，没有语言的转换。 第二种中提到用多台处理，消费转到了网络上，还有机器的协调上，所以其实也很难找到一个很好的算法。

**[ideawu](#11939 "2009-10-14 15:02:39"):** 毕竟是工作内容, 能理解. 能尝试各种技术, 看对性能的影响, 应该是一件很有趣的事情. 谢谢分享!

**[isll](#11974 "2009-11-04 23:19:04"):** 突然想起个问题，冒昧的问一句，不知道人人有没有考虑或者参考过facebook的cassanra等类似的小对象存储方案来满足自己的存储要求？

**[cc0cc](#11975 "2009-11-05 09:27:41"):** cassanra里的一个兄弟是来自亚马逊dynamo研发成员，我们正在实现类似的分布式key-value系统，我正好有幸参与研发这个项目。相信近期会推出一个全新的存储系统。

**[isll](#11979 "2009-11-05 19:25:40"):** 呵呵，希望推出来的时候能做个简要的介绍啊

**[isll](#11980 "2009-11-05 19:26:59"):** 呵呵，希望推出来的时候，能做个简单的介绍啊

**[cc0cc](#11981 "2009-11-06 22:21:49"):** 介绍那是必须的，没事常过来，：）

**[新之助](#12144 "2010-02-03 20:42:11"):** 好想加入人人 工作团队呀

**[cc0cc](#12146 "2010-02-04 17:38:05"):** 呵呵 欢迎加入哦，见右上脚的广告


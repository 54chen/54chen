title: [原创]Discuz! BBS缓存整体方案
link: http://www.54chen.com/php-tech/%e5%8e%9f%e5%88%9bdiscuz-bbs%e7%bc%93%e5%ad%98%e6%95%b4%e4%bd%93%e6%96%b9%e6%a1%88.html
author: cc0cc
description: 
post_id: 611
created: 2009/06/22 08:25:44
created_gmt: 2009/06/22 00:25:44
comment_status: open
post_name: %e5%8e%9f%e5%88%9bdiscuz-bbs%e7%bc%93%e5%ad%98%e6%95%b4%e4%bd%93%e6%96%b9%e6%a1%88
status: publish
post_type: post

# [原创]Discuz! BBS缓存整体方案

[ 文章作者：陈臻 本文版本：v1.0 最后修改：2009.6.22 转载请注明原文链接：<http://www.54chen.com/c/611> ]

[DZ的缓存方案](/c/505)是经典之作，不论是系统的主动缓存还是帖子内容的被动缓存。在我前面的博文【[[原创]Discuz! BBS的主动缓存和被动缓存](http://www.54chen.com/c/505)】里所讲述的是DZ的缓存常用的一种方法，下面再说在DZ系统里如何决定一个内容是不是要缓存。

所有的数据全都缓存，不失为一个好办法。但是，在数据更新要求及时的环境下，例如帖子回复的内容要求立即显示等地，又不得不对其缓存进行更新。所以，基本上每一个成熟的系统，都不会去把所有的东西缓存起来。这时是不是让各位很困惑，缓存就是一把双刃剑，用好了系统效率事半功倍，用得不好，产品功能将受到严重影响。DZ就是一个缓存与不缓存选取得当的系统。

我们一起进入DZ的viewthread.php，也就是负责显示帖子内容的一个文件。代码一开始有这样一个判断：

$page = max($page, 1);

if($cachethreadlife && $forum['threadcaches'] && !$discuz_uid && $page == 1 && !$forum['special']) {

       viewthread_loadcache();

}

这是什么意思呢？基本上就是在说，当一些系统的设置都满足的时候，只要是第一页就去执行viewthread_[load](/c/516)cache()，各位已经等不及看这个函数的意思了吧，且慢，先说说为什么选中了第一页。在经过大家长期的总结下，发现一个成熟论坛大多数时间会员都会停留在帖子的第一页，所以，DZ大胆地只将第一页进行缓存。

DZ真的是只将第一页进行缓存吗？答案是否定的，下面我们来看viewthread_loadcache()这个函数里的内容。

这个函数写在了viewthread.php的538行，看到这个函数的第一感觉，是专业。DZ的多年开发，已经将论坛的行为研究深深刻在了代码里。如下这段代码，这个函数里的$threadcachemark这个变量，被定义为与帖子的显示顺序、是否加精、此版最后回复天数、帖子浏览数、回复数、每页显示条数进行运算得到的一个值，如果这个值小于了版块的设置，这个帖子的内容才会生效。就也是说，DZ甚至还不是但凡第一页就缓存！

$threadcachemark = 100 - (

## Comments

**[九天鹰](#10619 "2009-06-22 23:54:54"):** 呵呵，可以尝试一下使用memcached缓存数据 有兴趣可以探讨一下 http://www.sysbus.com/?p=119

**[cc0cc](#10620 "2009-06-23 08:21:18"):** 呵呵 过两天有空我再写一篇用memcached的 初看了一下 兄弟你的改动太大了 ccvita博主有一个方案是修改db操作库的。你可以搜一下

**[金山老罗](#10644 "2009-07-07 10:43:17"):** 呵呵，坑点陈，啥时候回来喷喷啊～


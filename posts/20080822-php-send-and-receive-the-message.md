title: PHP“收发”邮件的一个程序
link: http://www.54chen.com/php-tech/php-send-and-receive-the-message.html
author: admin
description: 
post_id: 61
created: 2008/08/22 14:05:34
created_gmt: 2008/08/22 06:05:34
comment_status: open
post_name: php-send-and-receive-the-message
status: publish
post_type: post

# PHP“收发”邮件的一个程序

<?php if ($EMAIL_INC) return; $EMAIL_INC=   "defined"; define( "SmtpPort",25); class Pop3 { var $subject;                           // 邮件主题 var $from_email;                        // 发件人地址 var $from_name;                         // 发件人姓名 var $to_email;                          // 收件人地址 var $to_name;                           // 收件人姓名 var $body;                              // 邮件内容 var $filename;                          // 文件名 var $socket;                  // 当前的 socket var $Line; var $Status; function pop3_open($server, $port) { $this->Socket = fsockopen($server, $port); if ($this->Socket <= 0){ return false; } $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return false; return true; } function pop3_user($user) { if ($this->Socket < 0){ return false; } fputs($this->Socket,   "USER $this->user\r\n"); $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return false; return true; } function pop3_pass( $pass) { fputs($this->Socket,   "PASS $pass\r\n"); $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return 0; return 1; } function pop3_stat() { fputs($this->Socket,   "STAT\r\n"); $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return 0; if (!eregi( "+OK (.*) (.*)", $this->Line, $regs)) return 0; return $regs[1]; } function pop3_list() { fputs($this->Socket,   "LIST\r\n"); $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return 0; $i = 0; while   (substr($this->Line   =   fgets($this->Socket, 1024),   0,   1)   <>    ".") { $articles[$i] = $this->Line; $i++; } $articles[ "count"] = $i; return $articles; } function pop3_retr($nr) { fputs($this->Socket,   "RETR $nr\r\n"); $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return 0; while   (substr($this->Line   =   fgets($this->Socket, 1024),   0,   1)   <>    ".") { $data[$i] = $this->Line; $i++; } $data[ "count"] = $i; return $data; } function pop3_dele( $nr) { fputs($this->Socket,   "DELE $nr\r\n"); $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return 0; return 1; } function pop3_quit() { fputs($this->Socket,   "QUIT\r\n"); $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "+") return 0; return 1; } } class Smtp { var $Subject;               // string the email@#s subject var $FromName;                  // string sender@#s name (opt) var $ToName;                    // string recipient@#s name (opt) var $Body;                      // string body copy var $Attachment;          // attachment (optional) var $AttachmentType; var $Socket; var $Line; var $Status; function Smtp($Server =   "localhost",$Port = SmtpPort) { return $this->Open($Server, $Port); } function SmtpMail($FromEmail, $FromName, $ToEmail, $ToName, $Subject, $Body, $Attachment=null, $AttachmentType= "TEXT") { $this->Subject    = $Subject; $this->ToName     = $ToName; $this->FromName     = $FromName; $this->Body       = $Body; $this->Attachment = $Attachment; $this->AttachmentType = $AttachmentType; if ($this->Helo() == false){ return false; } if ($this->MailFrom($FromEmail) == false){ return false; } if ($this->RcptTo($ToEmail) == false){ return false; } if ($this->Body() == false){ return false; } if ($this->Quit() == false){ return false; } } function Open($Server, $Port) { $this->Socket = fsockopen($Server, $Port); if ($this->Socket < 0) return false; $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "2") return false; return true; } function Helo() { if (fputs($this->Socket,   "helo\r\n") < 0 ){ return false; } $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "2") return false; return true; } function Ehlo() { /* Well, let@#s use "helo" for now.. Until we need the extra func@#s    [Unk] */ if(fputs($this->Socket,   "helo localhost\r\n")<0){ return false; } $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "2") return false; return true; } function MailFrom($FromEmail) { if (fputs($this->Socket,   "MAIL FROM: <$FromEmail>\r\n")<0){ return false; } $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "2") return false; return true; } function RcptTo($ToEmail) { if(fputs($this->Socket,   "RCPT TO: <$ToEmail>\r\n")<0){ return false; } $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "2") return false; return true; } function Body() { $FileSize = 0; $Attachment = null; $fp = null; $buffer = sprintf( "From: %s\r\nTo:%s\r\nSubject:%s\r\n", $this->FromName, $this->ToName, $this->Subject); if(fputs($this->Socket,   "DATA\r\n")<0){ return false; } $this->Line = fgets($this->Socket, 1024); $this->Status[ "LASTRESULT"] = substr($this->Line, 0, 1); $this->Status[ "LASTRESULTTXT"] = substr($this->Line, 0, 1024); if ($this->Status[ "LASTRESULT"] <>   "3") return false; if(fputs($this->Socket, $buffer)<0){ return false; } if ($this->Attachment == null){ if(fputs($this->Socket,   "MIME-Version: 1.0\r\nContent-Type: text/plain; charset=ISO-8859-1\r\nContent-Transfer-Encoding: 7bit\r\n\r\n")<0){ return false; } if(fputs($this->Socket,   "$this->Body\r\n\r\n")<0){ return false; } if(fputs($this->Socket,   ".\r\n")<0){ return false; } $this->Line = fgets($this->Socket, 1024); if (substr($this->Line, 0, 1) <>   "2"){ return false; }else{ return true; } }else{
title: 54chen解读NoSQL代表Dynamo
link: http://www.54chen.com/_linux_/54chen-s-nosql.html
author: 54chen
description: 
post_id: 1189
created: 2010/06/18 10:57:01
created_gmt: 2010/06/18 02:57:01
comment_status: open
post_name: 54chen-s-nosql
status: publish
post_type: post

# 54chen解读NoSQL代表Dynamo

> 本文已经首发于[InfoQ中文站](http://www.infoq.com/cn/)，版权所有，原文为[《解读NoSQL技术代表之作Dynamo》](http://www.infoq.com/cn/articles/nosql-dynamo)，如需转载，请务必附带本声明，谢谢。 InfoQ中文站是一个面向中高端技术人员的在线独立社区，为Java、.NET、Ruby、SOA、敏捷、架构等领域提供及时而有深度的资讯、高端技术大会如[QCon](http://www.qconbeijing.com/)、免费迷你书下载如[《架构师》](http://www.infoq.com/cn/architect)等。

NoSQL在过去的一年里，逐渐已经成为了家喻户晓的东西，我（54chen）自从去年开始人人网的NoSQL系统Nuclear的研发以来，一直看着NoSQL越来越热，越来越引来大家的围观。受infoQ霍师傅之托，特作此文，一来作过去一年的总结，二来希望以平白的话语对NoSQL系统在国内的发展献绵薄之力。 1.我眼中的两种模式 NoSQL其实并不是什么妖魔鬼怪，相反的，NoSQL的真谛其实应该是Not Only SQL，其产生是在数据量和访问量的增大下，人为地去添加机器、切分数据到不同的机器，变得越来越困难，人力成本越来越高，于是便开始有了这样的项目，本意是提高数据存储的自动化程度，减少人为干预的时间，让负载更加均匀。在国际上，真正的代表之作有来自Google的 BigTable 和Amazon 的Dynamo，他们分别使用了不同的基本原理。 1.1 MapReduce 这是历史最久的一种模型，典型的代表是BigTable。Map表示映射，Reduce表示化简。MapReduce通过把对数据集的大规模操作分发给网络上的每个节点实现可靠性（Map）；每个节点会周期性的把完成的工作和状态的更新报告回来（Reduce）。大多数分布式运算可以抽象为MapReduce操作。Map是把输入Input分解成中间的Key/Value对，Reduce把Key/Value合成最终输出Output。这两个函数由程序员提供给系统，下层设施把Map和Reduce操作分布在集群上运行。 1.2 dynamo 我把dynamo专门归纳成为了一种，的确是这样的，它与MapReduce不同，自成一派。来说历史，Amazon于2006年推出了自己的云存储服务S3，2007年其CTO公布了S3的设计方案，从此江湖中就不再太平了，开源项目一个个如雨后春笋般地出现了。比较常见的有facebook开发的Cassandra（如果没有记错，在去年来到他们的项目网页的时候，上面还写着他们之中的一个开发人员是dynamo的设计人员，现在风头紧了，去掉了），还有linkedin的voldemort，国内的话，有豆瓣网的beansDB，人人网的nuclear等等。这次主要讲的也是dynamo的方案细节。 2.入门基础 Dynamo的意思是发电机，的确，这一整套的方案都像发电机一样，源源不断地提供服务，永不间断。以下内容看上去有点教条，但基本上要理解原理，这每一项都是必须知道的。 2.1 CAP原则 先来看历史，Eric A. Brewer教授，Inktomi公司的创始人，berkeley大学的计算机教授，Inktomi是雅虎搜索现在的台端技术核心支持。最主要的是，他们（Inktomi公司）在最早的时间里，开始研究分布计算。CAP原则的提出，可以追溯到2000年的时候（可以想象有多么早！），Brewer教授在一次talk中，基于他运作inktomi与在伯克利大学里的经验，总结出了CAP原则（后附当年的slide）。图2.1来自Brewer教授当年所画的图： ![cap](http://img06.taobaocdn.com/bao/uploaded/i6/T1vsxCXatFXXa7q0Ha_120538.jpg) 图2.1 Consistency(一致性)，数据一致性，简单的说，就是数据复制到了N台机器，如果有更新，要N机器的数据是一起更新的。 Availability(可用性)，好的响应性能，此项意思主要就是速度。 Partition tolerance(分区容错性)，这里是说好的分区方法，体现具体一点，简单地可理解为是节点的可扩展性。 定理：任何分布式系统只可同时满足二点，没法三者兼顾。 忠告：架构师不要将精力浪费在如何设计能满足三者的完美分布式系统，而是应该进行取舍。 2.2 DHT DHT(Distributed Hash Table，分布式哈希表)，它是一种分布式存储寻址方法的统称。就像普通的哈希表，里面保存了key与value的对应关系，一般都能根据一个key去对应到相应的节点，从而得到相对应的value。 这里随带一提，在DHT算法中，一致性哈希作为第一个实用的算法，在大多数系统中都使用了它。一致性哈希基本解决了在P2P环境中最为关键的问题——如何在动态的网络拓扑中分布存储和路由。每个节点仅需维护少量相邻节点的信息，并且在节点加入/退出系统时，仅有相关的少量节点参与到拓扑的维护中。至于一致性哗然的细节就不在这里详细说了，要指明的一点是，在Dynamo的数据分区方式之后，其实内部已然是一个对一致性哈希的改造了。 3.进入Dynamo的世界 有了上面一章里的两个基础介绍之后，我们开始进入Dynamo的世界。 3.1 Dynamo的数据分区与作用 在Dynamo的实现中提到一个关键的东西，就是数据分区。 假设我们的数据的 key 的范围是0到2的64次方（不用怀疑你的数据量会超过它，正常甚至变态情况下你都是超不过的，甚至像伏地魔等其他类Dynamo系统是使用的2^31-1），然后设置一个常数，比如说1000，将我们的key的范围分成1000份。然后再将这1000份key的范围均匀分配到所有的节点（s个节点），这样每个节点负责的分区数就是1000/s份分区。 如图3.1，假设我们有A、B、C三台机器，然后将我们的分区定义了12个。 ![dynamo数据分区](http://img03.taobaocdn.com/bao/uploaded/i3/T1hNFCXcNzXXbXlDIS_010258.jpg) 图3.1 因为数据是均匀离散到这个环上的（有人开始会认为数据的key是从1、2、3、4。。。这样子一直下去的，其实不是的，哈希计算出来的值，都是一个离散的结果），所以我们每个分区的数据量是大致相等的。从图上我们可以得出，每台机器都分到了三个分区里的数据，并且因为分区是均匀的，在分区数量是相当大的时候，数据的分布会更加的均匀，与此同时，负载也被均匀地分开了（当然了，如果硬要说你的负载还是只集中在一个分区里，那不是这里讨论的问题了，有可能是你的哈希函数是不是有什么样的问题了）。 为什么要进行这样的分布呢，分布的好处在于，在有新机器加入的时候，只需要替换原有分区即可，如图3.2所示： ![dynamo数据分区](http://img07.taobaocdn.com/bao/uploaded/i7/T1VhdCXcXHXXbngUMS_010414.jpg) 图3.2 同样是图3.1里的情况，12个分区分到ABC三个节点，图3.2中就是再进入了一个新的节点D，从图上的重新分布情况可以得出，所有节点里只需要转移四分之一的数据到新来的节点即可，同时，新节点的负载也伴随分区的转移而转移了（这里的12个分区太少了，如果是1200个分区甚至是12000个分区的话，这个结论就是正确的了，12个分区只为演示用） 3.2 从Dynamo的NRW看CAP法则 在Dynamo系统中，第一次提出来了NRW的方法。 N - 复制的次数 R - 读数据的最小节点数 W - 写成功的最小分区数 这三个数的具体作用呢，是用来灵活地调整Dynamo系统的可用性与一致性的。

## Comments

**[sintilla](#13150 "2010-10-28 16:25:07"):** 不知道是不是理解有错误，BigTable就是一种基于GFS的分布式存储系统，MapReduce是一种分布式并行计算模型吧。MapReduce应该跟NoSQL没有直接关系吧？

**[54chen](#13152 "2010-10-28 16:28:05"):** NoSQL是一个很广泛的概念，其实这里的意思是所有分布式的存储结构或方法。

**[sintilla](#13154 "2010-10-28 17:33:50"):** 冒昧了，不过个人感觉NoSQL是存储方面，MapReduce是并行计算模型，放在这里确实有些不恰当啊

**[54chen](#13156 "2010-10-28 17:47:27"):** 嗯，这样理解的确是不恰当，从分布式计算去理解就好多了。

**[guyu](#12446 "2010-06-18 15:57:58"):** 太高深了 路过灌个水吧

**[caner](#12524 "2010-07-25 19:09:23"):** 感觉写的比较乱，比较随意，知道的人不用看，不知道的人也看不懂！还是找其它资料吧。

